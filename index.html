<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>自由图片拼接工具（背景色 + 圆角 + 阴影 + 防抖）</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#f4f6f8; overflow:hidden; }
    #toolbar {
      position: fixed; top:0; left:0; right:0; height:80px;
      background:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.1);
      display:flex; align-items:center; gap:14px; padding:0 16px;
      flex-wrap:wrap; z-index:100;
    }
    button, input, select { padding:6px 12px; border-radius:6px; border:1px solid #d0d0d0; }
    button { background:#409eff; color:white; border:none; cursor:pointer; }
    button:hover { background:#79bbff; }
    .control-group { display:flex; align-items:center; gap:8px; white-space:nowrap; }
    input[type="range"] { width:140px; }
    input[type="color"] { width:40px; height:30px; padding:2px; }
    #container { position:absolute; inset:80px 0 0 0; overflow:auto; background:#e9ecef; }
    #canvas-wrapper {
      position:relative; min-width:600px; min-height:400px;
      background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%),
                  linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%);
      background-size:30px 30px; box-shadow:0 0 20px rgba(0,0,0,0.15);
      margin:40px auto; transition:background-color 0.3s;
    }
    #canvas { position:absolute; top:0; left:0; pointer-events:none; }
    .resize-handle { /* ... 原有样式不变 ... */ }
    .img-layer {
      position:absolute; cursor:move; user-select:none; touch-action:none;
      transform-origin:center center; transition:all 0.15s ease;
    }
    .img-layer.selected { outline:2px dashed #79bbff; box-shadow:0 0 0 3px #409eff; }
    .rotate-handle { /* ... 原有样式不变 ... */ }
  </style>
</head>
<body>

<div id="toolbar">
  <button onclick="document.getElementById('file').click()">+ 添加图片</button>
  <input type="file" id="file" multiple accept="image/*" style="display:none"/>

  <button onclick="applyNineGrid()">九宫格</button>
  <button onclick="autoArrange('row')">横向平铺</button>
  <button onclick="autoArrange('waterfall')">垂直瀑布</button>

  <div class="control-group">
    <label>间距：</label>
    <input type="range" id="spacingSlider" min="0" max="100" value="30" step="5">
    <span id="spacingValue">30 px</span>
  </div>

  <div class="control-group">
    <label>圆角：</label>
    <input type="range" id="radiusSlider" min="0" max="50" value="0" step="2">
    <span id="radiusValue">0 px</span>
  </div>

  <div class="control-group">
    <label>阴影：</label>
    <button id="shadowToggle" onclick="toggleShadow()">开启</button>
  </div>

  <div class="control-group">
    <label>背景色：</label>
    <input type="color" id="bgColor" value="#ffffff">
  </div>

  <button onclick="resetAll()">重置</button>
  <button onclick="exportImage()">保存 PNG</button>
</div>

<div id="container">
  <div id="canvas-wrapper">
    <canvas id="canvas"></canvas>
    <!-- 画布调整手柄（8个）保持不变 -->
    <div id="handle-t" class="resize-handle"></div>
    <div id="handle-b" class="resize-handle"></div>
    <div id="handle-l" class="resize-handle"></div>
    <div id="handle-r" class="resize-handle"></div>
    <div id="handle-tl" class="resize-handle"></div>
    <div id="handle-tr" class="resize-handle"></div>
    <div id="handle-bl" class="resize-handle"></div>
    <div id="handle-br" class="resize-handle"></div>
  </div>
</div>

<script>
// ==================== 全局状态 ====================
let layers = [];
let selected = null;
let isDraggingImage = false, dragOffsetX, dragOffsetY;
let isResizingCanvas = false, resizeDir = '';
let isRotating = false, rotateStartAngle = 0, rotateCenterX, rotateCenterY;
let globalMargin = 30;
let globalRadius = 0;
let globalShadow = true;
let bgColor = '#ffffff';

// DOM 元素
const wrapper = document.getElementById('canvas-wrapper');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// ==================== 防抖函数 ====================
function debounce(fn, delay = 300) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delay);
  };
}

const debouncedRearrange = debounce(() => {
  if (layers.length === 0) return;
  // 根据当前布局偏好重排（这里默认用 row，你可以改成你最常用的）
  autoArrange('row');
});

// ==================== 事件监听 ====================
document.getElementById('spacingSlider').addEventListener('input', e => {
  globalMargin = Number(e.target.value);
  document.getElementById('spacingValue').textContent = `${globalMargin} px`;
  debouncedRearrange();
});

document.getElementById('radiusSlider').addEventListener('input', e => {
  globalRadius = Number(e.target.value);
  document.getElementById('radiusValue').textContent = `${globalRadius} px`;
  updateAllImagesStyle();
});

document.getElementById('bgColor').addEventListener('input', e => {
  bgColor = e.target.value;
  wrapper.style.backgroundColor = bgColor;
  wrapper.style.backgroundImage = bgColor === '#ffffff' ? 
    'linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%), linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%)' : 
    'none';
});

function toggleShadow() {
  globalShadow = !globalShadow;
  document.getElementById('shadowToggle').textContent = globalShadow ? '开启' : '关闭';
  updateAllImagesStyle();
}

function updateAllImagesStyle() {
  document.querySelectorAll('.img-layer').forEach(el => {
    el.style.borderRadius = `${globalRadius}px`;
    el.style.boxShadow = globalShadow ? '0 4px 12px rgba(0,0,0,0.18)' : 'none';
  });
}

// ==================== 其余核心函数（addLayer, createLayerElement, 旋转, 九宫格, autoArrange, export 等） ====================
// 请将上一个版本中的这些函数完整复制过来，这里只展示修改部分

// 在 addLayer / createLayerElement 后调用一次初始样式
function addLayer(img, autoPosition = true) {
  // ... 原有代码 ...
  const layer = { el, img, w: w, h: h, rot: 0 };
  layers.push(layer);
  // 新增：应用当前全局样式
  el.style.borderRadius = `${globalRadius}px`;
  el.style.boxShadow = globalShadow ? '0 4px 12px rgba(0,0,0,0.18)' : 'none';
  // ... 其余不变 ...
}

// 在 autoArrange / applyNineGrid 中使用 globalMargin
// exportImage 中背景色使用 bgColor
function exportImage() {
  const temp = document.createElement('canvas');
  temp.width = canvas.width;
  temp.height = canvas.height;
  const tctx = temp.getContext('2d');

  tctx.fillStyle = bgColor;
  tctx.fillRect(0, 0, temp.width, temp.height);

  layers.forEach(layer => {
    const rect = layer.el.getBoundingClientRect();
    const base = wrapper.getBoundingClientRect();
    const x = rect.left - base.left;
    const y = rect.top - base.top;
    const w = rect.width;
    const h = rect.height;

    tctx.save();
    tctx.translate(x + w/2, y + h/2);
    tctx.rotate(layer.rot * Math.PI / 180);
    tctx.drawImage(layer.img, -w/2, -h/2, w, h);
    tctx.restore();
  });

  const a = document.createElement('a');
  a.href = temp.toDataURL('image/png');
  a.download = `拼图_${new Date().toISOString().slice(0,10)}.png`;
  a.click();
}

// ... 其他函数（画布拖拽、旋转、选中、重置等）保持不变 ...
</script>
</body>
</html>
