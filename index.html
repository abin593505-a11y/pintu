<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>图片自由拼接工具 - 优化版</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --primary: #409eff;
    --primary-light: #79bbff;
    --gray: #f4f6f8;
    --shadow-sm: 0 2px 12px rgba(0,0,0,0.12);
    --shadow-md: 0 6px 16px rgba(0,0,0,0.2);
  }
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--gray);
    overflow: hidden;
  }
  #toolbar {
    position: fixed;
    inset: 0 0 auto 0;
    height: 90px;
    background: white;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 0 16px;
    flex-wrap: wrap;
    z-index: 100;
  }
  button, input, select {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #d0d0d0;
  }
  button {
    background: var(--primary);
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover:not(:disabled) { background: var(--primary-light); }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  .control-group { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
  input[type="range"] { width: 110px; }
  input[type="color"] { width: 36px; height: 28px; padding: 2px; }
  #container {
    position: absolute;
    inset: 90px 0 0 0;
    overflow: auto;
    background: #e9ecef;
  }
  #canvas-wrapper {
    position: relative;
    min-width: 600px;
    min-height: 400px;
    margin: 30px auto;
    background: 
      linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%),
      linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%);
    background-size: 30px 30px;
    box-shadow: var(--shadow-sm);
    transition: background-color 0.3s;
  }
  #canvas { position: absolute; inset: 0; pointer-events: none; }
  .resize-handle {
    position: absolute;
    width: 18px; height: 18px;
    background: var(--primary);
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    z-index: 20;
  }
  .layer {
    position: absolute;
    cursor: move;
    user-select: none;
    touch-action: none;
    transform-origin: center;
    transition: all 0.12s ease;
    z-index: 10;
  }
  .img-layer { background: white; }
  .text-layer {
    padding: 8px;
    border: 1px dashed #aaa;
    min-width: 80px;
    min-height: 30px;
    background: rgba(255,255,255,0.7);
  }
  .layer.selected {
    box-shadow: 0 0 0 4px var(--primary) inset, 0 6px 16px rgba(0,0,0,0.25);
    outline: 2px dashed #a0cfff;
  }
  .rotate-handle {
    position: absolute;
    top: -24px; left: 50%;
    transform: translateX(-50%);
    width: 28px; height: 28px;
    background: var(--primary);
    border: 4px solid white;
    border-radius: 50%;
    cursor: grab;
    display: none;
    z-index: 10;
  }
  .layer.selected .rotate-handle { display: block; }
</style>
</head>
<body>

<div id="toolbar">
  <button id="addImgBtn">+ 添加图片</button>
  <input type="file" id="fileInput" multiple accept="image/*" style="display:none">

  <button id="addBgBtn">+ 背景图</button>
  <input type="file" id="bgInput" accept="image/*" style="display:none">

  <button id="removeBgBtn" style="display:none">移除背景</button>

  <div class="control-group">
    <label>背景模糊</label>
    <input type="range" id="bgBlur" min="0" max="20" value="0" step="0.5">
    <span id="blurVal">0 px</span>
  </div>

  <div class="control-group">
    <label>背景透明</label>
    <input type="range" id="bgOpacity" min="0" max="100" value="100" step="5">
    <span id="opacityVal">100%</span>
  </div>

  <select id="bgFitMode">
    <option value="cover">cover（填充裁剪）</option>
    <option value="contain">contain（完整显示）</option>
    <option value="tile">平铺</option>
  </select>

  <button id="addTextBtn">+ 文本</button>
  <button id="smartLayoutBtn">AI 智能布局</button>
  <button id="nineGridBtn">九宫格</button>
  <button id="rowLayoutBtn">横向平铺</button>
  <button id="waterfallBtn">垂直瀑布</button>

  <div class="control-group"><label>间距</label><input type="range" id="marginSlider" min="0" max="80" value="30"><span id="marginVal">30</span></div>
  <div class="control-group"><label>圆角</label><input type="range" id="radiusSlider" min="0" max="60" value="12"><span id="radiusVal">12</span></div>
  <div class="control-group"><button id="shadowToggle">阴影:开</button></div>
  <div class="control-group"><label>背景色</label><input type="color" id="bgColorPicker" value="#f8f9fa"></div>

  <button id="resetBtn">重置</button>
  <button id="exportBtn">导出 PNG</button>
</div>

<div id="container">
  <div id="canvas-wrapper">
    <canvas id="canvas"></canvas>
    <div class="resize-handle" id="h-t"></div>
    <div class="resize-handle" id="h-b"></div>
    <div class="resize-handle" id="h-l"></div>
    <div class="resize-handle" id="h-r"></div>
    <div class="resize-handle" id="h-tl"></div>
    <div class="resize-handle" id="h-tr"></div>
    <div class="resize-handle" id="h-bl"></div>
    <div class="resize-handle" id="h-br"></div>
  </div>
</div>

<script>
// ==================== 核心状态 ====================
const state = {
  layers: [],
  selected: null,
  backgroundImg: null,
  bgBlur: 0,
  bgOpacity: 1,
  bgFit: 'cover',
  margin: 30,
  radius: 12,
  shadowEnabled: true,
  bgColor: '#f8f9fa'
};

const dom = {
  wrapper: document.getElementById('canvas-wrapper'),
  canvas: document.getElementById('canvas'),
  ctx: document.getElementById('canvas').getContext('2d'),
  fileInput: document.getElementById('fileInput'),
  bgInput: document.getElementById('bgInput'),
  removeBgBtn: document.getElementById('removeBgBtn'),
  bgBlur: document.getElementById('bgBlur'),
  blurVal: document.getElementById('blurVal'),
  bgOpacity: document.getElementById('bgOpacity'),
  opacityVal: document.getElementById('opacityVal'),
  bgFitMode: document.getElementById('bgFitMode'),
  marginSlider: document.getElementById('marginSlider'),
  marginVal: document.getElementById('marginVal'),
  radiusSlider: document.getElementById('radiusSlider'),
  radiusVal: document.getElementById('radiusVal'),
  shadowToggle: document.getElementById('shadowToggle'),
  bgColorPicker: document.getElementById('bgColorPicker')
};

let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let isRotating = false;
let rotStartAngle = 0;
let isResizingCanvas = false;
let resizeDir = '';

// ==================== 初始化 ====================
function init() {
  resizeCanvas(1400, 1000);
  redrawBackground();
  updateGlobalStyles();

  // 事件绑定
  dom.fileInput.addEventListener('change', handleImageUpload);
  dom.bgInput.addEventListener('change', handleBackgroundUpload);
  dom.bgBlur.addEventListener('input', e => {
    state.bgBlur = +e.target.value;
    dom.blurVal.textContent = state.bgBlur;
    requestAnimationFrame(redrawBackground);
  });
  dom.bgOpacity.addEventListener('input', e => {
    state.bgOpacity = +e.target.value / 100;
    dom.opacityVal.textContent = e.target.value;
    requestAnimationFrame(redrawBackground);
  });
  dom.bgFitMode.addEventListener('change', e => {
    state.bgFit = e.target.value;
    redrawBackground();
  });
  dom.bgColorPicker.addEventListener('input', e => {
    state.bgColor = e.target.value;
    dom.wrapper.style.backgroundColor = state.bgColor;
    dom.wrapper.style.backgroundImage = state.bgColor === '#ffffff' ?
      'linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%), linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%)' : 'none';
  });
  dom.shadowToggle.addEventListener('click', toggleShadow);
  dom.marginSlider.addEventListener('input', e => {
    state.margin = +e.target.value;
    dom.marginVal.textContent = state.margin;
  });
  dom.radiusSlider.addEventListener('input', e => {
    state.radius = +e.target.value;
    dom.radiusVal.textContent = state.radius;
    updateGlobalStyles();
  });

  // 按钮事件（示例，需自行实现具体函数）
  document.getElementById('addImgBtn').onclick = () => dom.fileInput.click();
  document.getElementById('addBgBtn').onclick = () => dom.bgInput.click();
  document.getElementById('addTextBtn').onclick = addTextLayer;
  document.getElementById('smartLayoutBtn').onclick = applySmartLayout;
  document.getElementById('nineGridBtn').onclick = applyNineGrid;
  document.getElementById('rowLayoutBtn').onclick = () => autoArrange('row');
  document.getElementById('waterfallBtn').onclick = () => autoArrange('waterfall');
  document.getElementById('resetBtn').onclick = resetAll;
  document.getElementById('exportBtn').onclick = exportImage;
}

function handleImageUpload(e) {
  const files = e.target.files;
  if (!files?.length) return;

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => addImageLayer(img);
      img.onerror = () => alert('图片加载失败，请尝试其他文件');
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
  e.target.value = ''; // 清空以便重复上传相同文件
}

function handleBackgroundUpload(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      state.backgroundImg = img;
      dom.removeBgBtn.style.display = 'inline-block';
      redrawBackground();
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

// ==================== 核心函数（占位，需实现） ====================
function addImageLayer(img) {
  // 实现添加图片层逻辑
  console.log('添加图片:', img.width, img.height);
}

function addTextLayer() {
  // 实现添加文本层逻辑
  console.log('添加文本层');
}

function applySmartLayout() { console.log('AI智能布局'); }
function applyNineGrid() { console.log('九宫格'); }
function autoArrange(mode) { console.log('自动排列:', mode); }

function toggleShadow() {
  state.shadowEnabled = !state.shadowEnabled;
  dom.shadowToggle.textContent = `阴影:${state.shadowEnabled ? '开' : '关'}`;
  updateGlobalStyles();
}

function updateGlobalStyles() {
  state.layers.forEach(l => {
    l.el.style.borderRadius = `${state.radius}px`;
    l.el.style.boxShadow = state.shadowEnabled ? '0 6px 16px rgba(0,0,0,0.2)' : 'none';
  });
}

function resizeCanvas(w, h) {
  w = Math.max(400, Math.round(w));
  h = Math.max(300, Math.round(h));
  dom.canvas.width = w;
  dom.canvas.height = h;
  dom.wrapper.style.width = `${w}px`;
  dom.wrapper.style.height = `${h}px`;
  redrawBackground();
}

function redrawBackground() {
  const {ctx, canvas: {width, height}} = dom;
  ctx.clearRect(0, 0, width, height);

  if (!state.backgroundImg) return;

  ctx.globalAlpha = state.bgOpacity;
  ctx.filter = `blur(${state.bgBlur}px)`;

  // 根据 bgFit 模式绘制（cover/contain/tile）
  // 此处省略具体实现逻辑，与之前版本一致
  ctx.globalAlpha = 1;
  ctx.filter = 'none';
}

function resetAll() {
  state.layers = [];
  dom.wrapper.querySelectorAll('.layer').forEach(el => el.remove());
  state.backgroundImg = null;
  state.bgBlur = 0;
  state.bgOpacity = 1;
  state.bgFit = 'cover';
  dom.bgBlur.value = 0;
  dom.blurVal.textContent = 0;
  dom.bgOpacity.value = 100;
  dom.opacityVal.textContent = 100;
  dom.bgFitMode.value = 'cover';
  dom.removeBgBtn.style.display = 'none';
  resizeCanvas(1400, 1000);
  state.selected = null;
  redrawBackground();
  updateGlobalStyles();
}

function exportImage() {
  alert('导出功能待实现');
  // 实现导出逻辑...
}

// ==================== 启动 ====================
init();
</script>
</body>
</html>
